#! /usr/bin/env perl
#
# Short description for cg.pl
#
# Author josephzeng <josephzeng36@gmail.com>
# Version 0.1
# Copyright (C) 2017 josephzeng <josephzeng36@gmail.com>
# Modified On 2017-07-07 14:38
# Created  2017-07-07 14:38
#
use strict;
use warnings;

use AnyEvent;
use AnyEvent::Handle;
use Data::Dumper;

use v5.20.2;

my $cv = AnyEvent->condvar;
my $hdl; $hdl = AnyEvent::Handle->new(
    connect => ['192.168.97.55', 9841],
    keepalive => 1,
    on_connect => sub {
        say "connect ok";
        $hdl->push_write("123");
        say "todo";
        $hdl->push_read (line => sub {
            my ($read_hdl, $line) = @_;
            say "got line <$line>";
        });
    },
    on_connect_error => sub{
        say "could not connect\n";
        $hdl->destroy;
    },
    on_error => sub{
        $hdl->destroy;
    },
    on_eof => sub{
        $hdl->destroy;
    },
    on_read => sub{
        my ($self) = @_;
        $self->unshift_read(line => sub {
            my ($read_hdl,$data) = @_;
            print $data."\n";
        });
    },
);

#$hdl->push_write("abc");
#say "yes123";
##$hdl->push_read (line => sub {
##    my ($hdl, $line) = @_;
##    say "got line <$line>";
##    $cv->send;
##});
$cv->recv;



