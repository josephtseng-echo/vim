<?php

namespace Oil\Admin\Controller;

use Oil\Form, St\Api, St\Mvc\Controller\RestfulModuleController, St\View\Model\ViewModel;
use Zend\View\Model\JsonModel;

class TankController extends RestfulModuleController
{
	protected $renders = array( 
		'restPutTank' => 'tank/get',
		'restPostTank' => 'tank/get',
		'restCreateTank' => 'tank/get'
	);
	public function restIndexTank()
	{

		//var_dump($this->getEventManager()->getEvents());
		$request = $this->getRequest();
		
		$query = $request->getQuery();
		
		$form = new Form\TankSearchForm();
	    $form->bind($query)->isValid();
		$selectQuery = $form->getData();
		//p($selectQuery);
		$itemModel = Api::_()->getModel('Oil\Model\Tank');
		
		if (!$selectQuery)
		{
			$selectQuery = array( 
				'page' => 1, 
			//	'status' => 'active'
			);
		}
		//$selectQuery['city'] = '1';
		$selectQuery['order'] = 'iddesc';
		//$selectQuery['rows'] = 20;
		//print_r($selectQuery);
		$selectQuery['users_id'] = 0;
		$myInfo = api::_()->getMyInfo();
		$users_id = $myInfo['id'];
		$users_name = $myInfo['userName'];
		if($users_id and $users_id != 1){
			$selectQuery['users_id'] = $users_id;
		}		
        $station = $query['station'];

		

		$items = $itemModel->setMap(array( 
			'self' => array( 
				'*' 
			) 
		)
		)->setItemList($selectQuery)->getList();
		
		$items = $items->toArray();
		//p($items);
		$paginator = $itemModel->getPaginator();
		
		$config=Api::_()->getConfig();
		$oil_items = array();
		if($config['oil']){
			foreach($config['oil'] as $key => $val){
				$oil_items[$key] = $val;
			}
		}
		$itemModel = Api::_()->getModel('Oil\Model\Station');
		$station_items = $itemModel->getStations();
		return array( 
			'form' => $form, 
			'items' => $items, 
			'query' => $query,
			'oil_items' => $oil_items,
            'station_items' => $station_items,
            'station' => $station,
			'paginator' => $paginator 
		);
	}
	public function restGetTank()
	{
		$myInfo = api::_()->getMyInfo();
		$station = 0;
		if(isset($myInfo['isSuperAdmin']) and !empty($myInfo['isSuperAdmin'])){
		}else{
			$station = $myInfo['station'];
		}		
		$id = $this->params('id');
		
		$itemModel = Api::_()->getModel('Oil\Model\Tank');
		$item = $itemModel->get($id);
		
		$item = $item->toArray(array( 
			'self' => array( 
				'*' 
			) 
		)
		);
		$this->layout('layout/adminmodel');

		return array( 
			'item' => $item,
			'no' => $station
		);
	}
	public function restCreateTank()
	{
	    $myInfo = api::_()->getMyInfo();
        $station = 0;
        if(isset($myInfo['isSuperAdmin']) and !empty($myInfo['isSuperAdmin'])){
        }else{
            $station = $myInfo['station'];
        }
        $sno = isset($_REQUEST['sno']) ? trim($_REQUEST['sno']) : $station;
		$this->layout('layout/adminmodel');
		return array( 
			'item' => $item,
            'no' => $station
		);
	}
	public function restPostTank()
	{
		$postData = $this->params()->fromPost();
		$form = new Form\TankCreateForm();
		$form->bind($postData);
		
		if ($form->isValid())
		{
			$postData = $form->getData();
		    $myInfo = api::_()->getMyInfo();
            if(isset($myInfo['isSuperAdmin'])){
                $users_id = $myInfo['id'];
                $users_name = $myInfo['userName'];
            }else{
                $users_name = $myInfo['userName'];
                $users_id = $myInfo['id'];
            }
            $postData['depot'] = strtolower($postData['depot']);
            $postData['users_id'] = $users_id;
            $postData['users_name'] = $users_name;
            unset($postData['station']);
			$itemModel = Api::_()->getModel('Oil\Model\Tank');
			$itemId = $itemModel->setItem($postData)->create();
			$this->flashMessenger()->addSuccessMessage('商品新增成功');
			$this->redirect()->toUrl('/admin/core/core/reload');
		}
		else
		{
		}
		$this->layout('layout/adminmodel');
		return array( 
			'form' => $form 
		);
	}
	public function restPutTank()
	{
		$request = $this->getRequest();
		$postData = $request->getPost();
		
		$form = new Form\TankEditForm();
		$form->bind($postData);
		
		if ($form->isValid())
		{
			$postData = $form->getData();
			$myInfo = api::_()->getMyInfo();
			if(isset($myInfo['isSuperAdmin'])){
				$users_id = $myInfo['id'];
				$users_name = $myInfo['userName'];
			}else{
				$users_name = $myInfo['userName'];
				$users_id = $myInfo['id'];
			}
			$postData['depot'] = strtolower($postData['depot']);
			$postData['users_id'] = $users_id;
			$postData['users_name'] = $users_name;
			$itemModel = Api::_()->getModel('Oil\Model\Tank');
			unset($postData['station']);
			$itemId = $itemModel->setItem($postData)->save();
			$this->flashMessenger()->addSuccessMessage('修改成功');
			$this->redirect()->toUrl('/admin/core/core/reload');
		}
		else
		{
			//$this->flashMessenger()->addMessage('');
			//$flashMesseger = array('post-edit-failed');
		}
		$this->layout('layout/adminmodel');
		return array( 
			'item' => $postData, 
			'form' => $form 
		);
	}
	public function restDeleteTank()
	{
		$this->changeViewModel('json');
		$request = $this->getRequest();
		$postData = $request->getPost();
		$callback = $request->getPost()->get('callback');
		
		$id = $this->params('id');
		
		$itemModel = Api::_()->getModel('Oil\Model\Tank');
		$myInfo = api::_()->getMyInfo();
		$users_id = $myInfo['id'];
		$users_name = $myInfo['userName'];
		$data = array( 
			'id' => $id 
		);
		if($users_id and $users_id != 1){
			$data['users_id'] = $user_id;
		}		
		$itemId = $itemModel->remove($data);
		$this->flashMessenger()->addSuccessMessage('刪除成功');
		return new JsonModel($itemModel = Api::_()->showOk());
	}
}

