<?php
/**
 * Short description for app.php
 *
 * @package app
 * @author josephzeng <josephzeng36@gmail.com>
 * @version 0.1
 * @copyright (C) 2017 josephzeng <josephzeng36@gmail.com>
 * @license MIT
 */

use Silex\Application;
use Silex\Provider\HttpCacheServiceProvider;
use Silex\Provider\DoctrineServiceProvider;
use Silex\Provider\MonologServiceProvider;
use Silex\Provider\ServiceControllerServiceProvider;
use Symfony\Component\HttpFoundation\JsonResponse;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\HttpFoundation\Request;
use Carbon\Carbon;



if(ENVIRONMENT_INI == 'production'){
    require ROOT_PATH.'/app/config/production.php';
}
$app->register(new \Euskadi31\Silex\Provider\CorsServiceProvider);
$app->register(new ServiceControllerServiceProvider());

$app->register(new DoctrineServiceProvider(), array(
    "db.options" => $app["db.options"]
));
$app->register(new Predis\Silex\ClientsServiceProvider(),array(
    "predis.clients"
));

$app->register(new HttpCacheServiceProvider(), array("http_cache.cache_dir" => ROOT_PATH . "/data/cached",));
$app->register(new MonologServiceProvider(), array(
    "monolog.logfile" => ROOT_PATH . "/data/logs/" . Carbon::now('Asia/Shanghai')->format("Y-m-d") . ".log",
    "monolog.level" => Monolog\Logger::INFO,
    "monolog.name" => "application"
));

require __DIR__.'/config/services.php';
require __DIR__.'/config/routes.php';


$app->error(function (\Exception $e, $code) use ($app) {
    $app['monolog']->addError($e->getMessage());
    $app['monolog']->addError($e->getTraceAsString());
    exit(500);
});

return $app;
